apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: otel-collector
  namespace: default
  labels:
    app: otel-collector
spec:
  selector:
    matchLabels:
      app: otel-collector
  template:
    metadata:
      labels:
        app: otel-collector
      annotations:
        sidecar.istio.io/inject: "false"  # Disable Istio sidecar injection
    spec:
      hostNetwork: true
      serviceAccountName: otel-collector
      initContainers:
        - name: fetch-secrets
          image: amazon/aws-cli:latest
          command:
            - /bin/sh
            - -c
            - |
              set -e
              # Install kubectl
              curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
              chmod +x kubectl
              mv kubectl /usr/local/bin/kubectl || mv kubectl /bin/kubectl
              
              SECRET_NAME="${AWS_SECRET_NAME:-istio/otel-collector/elastic}"
              AWS_REGION="${AWS_REGION:-us-east-1}"
              
              echo "Fetching secret from AWS Secrets Manager: $SECRET_NAME"
              
              # Fetch secret from AWS Secrets Manager
              SECRET_JSON=$(aws secretsmanager get-secret-value \
                --secret-id "$SECRET_NAME" \
                --region "$AWS_REGION" \
                --query SecretString \
                --output text)
              
              # Parse JSON - try jq first, then fallback to sed
              if command -v jq &> /dev/null; then
                ELASTIC_ENDPOINT=$(echo "$SECRET_JSON" | jq -r '.endpoint')
                ELASTIC_API_KEY=$(echo "$SECRET_JSON" | jq -r '.apiKey')
              else
                # Fallback to sed if jq is not available
                ELASTIC_ENDPOINT=$(echo "$SECRET_JSON" | sed -n 's/.*"endpoint":"\([^"]*\)".*/\1/p')
                ELASTIC_API_KEY=$(echo "$SECRET_JSON" | sed -n 's/.*"apiKey":"\([^"]*\)".*/\1/p')
              fi
              
              # Write to shared volume as files
              echo "$ELASTIC_ENDPOINT" > /secrets/ELASTIC_ENDPOINT
              echo "$ELASTIC_API_KEY" > /secrets/ELASTIC_API_KEY
              
              # Create or update ConfigMap with the secrets
              # This allows the distroless collector image to access them as env vars
              kubectl create configmap otel-collector-env \
                --from-literal=ELASTIC_ENDPOINT="$ELASTIC_ENDPOINT" \
                --from-literal=ELASTIC_API_KEY="$ELASTIC_API_KEY" \
                --dry-run=client -o yaml | kubectl apply -f - || \
              kubectl patch configmap otel-collector-env -p "{\"data\":{\"ELASTIC_ENDPOINT\":\"$ELASTIC_ENDPOINT\",\"ELASTIC_API_KEY\":\"$ELASTIC_API_KEY\"}}" || \
              kubectl create configmap otel-collector-env \
                --from-literal=ELASTIC_ENDPOINT="$ELASTIC_ENDPOINT" \
                --from-literal=ELASTIC_API_KEY="$ELASTIC_API_KEY"
              
              echo "Secrets fetched and written successfully"
              chmod 644 /secrets/ELASTIC_ENDPOINT /secrets/ELASTIC_API_KEY
          env:
            - name: AWS_SECRET_NAME
              value: "istio/otel-collector/elastic"
            - name: AWS_REGION
              value: "us-east-1"
            # AWS credentials from secret (for non-EKS clusters)
            # These are optional - if using IRSA or instance profiles, these will be ignored
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: aws-access-key-id
                  optional: true
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: aws-secret-access-key
                  optional: true
            - name: AWS_SESSION_TOKEN
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: aws-session-token
                  optional: true
          volumeMounts:
            - name: secrets
              mountPath: /secrets
      containers:
        - name: otel-collector
          image: otel/opentelemetry-collector-contrib:0.100.0
          args:
            - --config=/conf/config.yaml
          env:
            - name: ELASTIC_ENDPOINT
              valueFrom:
                configMapKeyRef:
                  name: otel-collector-env
                  key: ELASTIC_ENDPOINT
                  optional: true
            - name: ELASTIC_API_KEY
              valueFrom:
                configMapKeyRef:
                  name: otel-collector-env
                  key: ELASTIC_API_KEY
                  optional: true
          ports:
            - containerPort: 4317
              name: otlp-grpc
            - containerPort: 4318
              name: otlp-http
            - containerPort: 8888
              name: metrics
          volumeMounts:
            - name: config
              mountPath: /conf
            - name: secrets
              mountPath: /secrets
              readOnly: true
      volumes:
        - name: config
          configMap:
            name: otel-collector-config
        - name: secrets
          emptyDir: {}
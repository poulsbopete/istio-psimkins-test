apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: default
data:
  config.yaml: |
    receivers:
      otlp:
        protocols:
          http: {}
          grpc: {}

      prometheus:
        config:
          scrape_configs:
            # Scrape Istio ingress gateway - using static config with verified IP
            - job_name: 'istio-gateways'
              static_configs:
                - targets: ['192.168.59.87:15090']
                  labels:
                    service_name: istio_gateways
                    job: istio-gateways
                    pod_name: istio-ingressgateway
              metrics_path: /stats/prometheus
              scrape_interval: 10s
              scrape_timeout: 5s
            
            # Scrape Istio sidecars - using static config with verified IP
            - job_name: 'istio-sidecars'
              static_configs:
                - targets: ['192.168.1.173:15090']
                  labels:
                    service_name: frontend
                    job: istio-sidecars
                    namespace: default
                    pod_name: frontend
              metrics_path: /stats/prometheus
              scrape_interval: 10s
              scrape_timeout: 5s

    processors:
      memory_limiter:
        check_interval: 1s
        limit_mib: 450
        spike_limit_mib: 128

      k8sattributes:
        extract:
          metadata:
            - k8s.namespace.name
            - k8s.pod.name
            - k8s.deployment.name
            - k8s.node.name

      transform:
        metric_statements:
          - context: resource
            statements:
              # Set service.name directly from job (Prometheus receiver sets job in resource attributes)
              - set(attributes["service.name"], "istio_gateways") where attributes["job"] == "istio-gateways"
              - set(attributes["service.name"], "frontend") where attributes["job"] == "istio-sidecars"

      batch:
        send_batch_size: 100
        timeout: 1s

    exporters:
      otlphttp/elastic:
        endpoint: "${ELASTIC_ENDPOINT}"
        headers:
          Authorization: "ApiKey ${ELASTIC_API_KEY}"
        compression: gzip
        # OTLP HTTP exporter automatically appends /v1/metrics, /v1/traces, /v1/logs

    service:
      pipelines:
        traces:
          receivers: [otlp]
          processors: [memory_limiter, k8sattributes, batch]
          exporters: [otlphttp/elastic]

        metrics:
          receivers: [otlp, prometheus]
          processors: [memory_limiter, k8sattributes, transform, batch]
          exporters: [otlphttp/elastic]

        logs:
          receivers: [otlp]
          processors: [memory_limiter, k8sattributes, batch]
          exporters: [otlphttp/elastic]
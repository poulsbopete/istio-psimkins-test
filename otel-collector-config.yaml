apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: default
data:
  config.yaml: |
    receivers:
      otlp:
        protocols:
          http: {}
          grpc: {}

      prometheus:
        config:
          scrape_configs:
            - job_name: 'istio-gateways'
              static_configs:
                - targets:
                    - "192.168.23.0:15090"
              metrics_path: /stats/prometheus
              scrape_interval: 15s

    processors:
      memory_limiter:
        check_interval: 1s
        limit_mib: 450
        spike_limit_mib: 128

      k8sattributes:
        extract:
          metadata:
            - k8s.namespace.name
            - k8s.pod.name
            - k8s.deployment.name
            - k8s.node.name

      batch:
        send_batch_size: 1024
        timeout: 200ms

    exporters:
      otlphttp/elastic:
        endpoint: "${ELASTIC_ENDPOINT}"
        headers:
          Authorization: "ApiKey ${ELASTIC_API_KEY}"
        compression: gzip
        # For Elastic ingest endpoint, OTLP paths are automatically handled
        # Metrics: /v1/metrics, Traces: /v1/traces, Logs: /v1/logs

    service:
      pipelines:
        traces:
          receivers: [otlp]
          processors: [memory_limiter, k8sattributes, batch]
          exporters: [otlphttp/elastic]

        metrics:
          receivers: [prometheus]
          processors: [memory_limiter, k8sattributes, batch]
          exporters: [otlphttp/elastic]

        logs:
          receivers: [otlp]
          processors: [memory_limiter, k8sattributes, batch]
          exporters: [otlphttp/elastic]